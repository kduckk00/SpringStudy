# CLASS 05 어노테이션 기반 AOP

  스프링 IoC를 학습하면서 XML 기반 설정과 어노테이션 기반 설정을 모두 사용했었다. 그리고 XML과 어노테이션 설정을 적절히 혼합하여 사용하면 XML 설정을 최소화하면서 객체들을 효율적으로 관리할 수 있었다. 스프링 AOP도 IoC와 마찬가지로 어노테이션 설정을 지원한다.



## 5.1 어노테이션 기반 AOP 설정

   AOP를 어노네이션으로 설정하려면 가장 먼저 스프링 설정 파일에 < aop:aspectj-autoproxy > 엘리먼트를 선언해야 한다.

### 5.1.1 어노테이션 사용을 위한 스프링 설정

   < aop:aspectj-autoproxy >< /aop:aspectj-autoproxy > 엘리먼트만 선언하면 스프링 컨테이너는 AOP 관련 어노테이션들을 인식하고 용도에 맞게 처리해준다.

   AOP 관련 어노테이션들은 어드바이스 클래스에 설정한다. 그리고 어드바이스 클래스에 선언된 어노테이션들을 스프링 컨테이너가 처리하게 하려면, 반드시 어드바이스 객체가 생성되어 있어야 한다. 따라서 어드바이스 클래스는 반드시 스프링 설정 파일에 < bean > 등록하거나 @Service 어노테이션을 사용하여 컴포넌트가 검색될 수 있도록 해야 한다.


### 5.1.2 포인트컷 설정

 어노테이션 설정으로 포인트컷을 선언할 때는 @Pointcut을 사용하며, 하나의 어드바이스 클래스 안에 여러 개의 포인트컷을 선언할 수 있다. 따라서 여러 포인트컷을 식별하기 위한 식별자가 필요한데, 이때 참조 메소드를 이용한다.


### 5.1.3 어드바이스 설정

 포인트컷을 참조하는 방법은 어드바이스 어노테이션 뒤에 괄호를 추가하고 포인트컷 참조 메소드를 지정하면 된다.

| 어노테이션      | 설명                                                         |
| --------------- | ------------------------------------------------------------ |
| @Before         | 비즈니스 메소드 실행 전에 동작                               |
| @AfterReturning | 비즈니스 메소드가 성공적으로 리턴되면 동작                   |
| @AfterThrowing  | 비즈니스 메소드 실행 중 예외가 발생하면 동작(마치 try~catch 블록에서 catch 블록에 해당) |
| @After          | 비즈니스 메소드가 실행된 후, 무조건 실행 (try~catch~finally 블록에서 finally 블록에 해당) |
| @Around         | 호출 자체를 가로채 비즈니스 메소드 실행 전후에 처리할 로직을 삽입할 수 있음 |

### 5.1.4 애스팩트 설정

~~책 사진~~

 LogAdvice 클래스 위에 @Aspect가 설정되었으므로 스프링 컨테이너는 LogAdvice 객체를 애스팩트 객체로 인식한다. 그리고 LogAdvice에는 포인트컷 메소드(allPointcut()) 와 어드바이스 메소드(printLog()) 가 선언되어 있는데, 이 두 메소드에 설정된 어노테이션에 의해 위빙이 처리된다.



## 5.2 어드바이스 동작 시점

### 5.2.1 Before 어드바이스

   Before 어드바이스는 비즈니스 메소드가 실행되기 전에 공통으로 처리할 작업을 위해 사용한다. 앞에서 작성한 BeforeAdvice 클래스에 관련된 어노테이션을 추가한다. 

### 5.2.2 After Returning

   After Returning 어드바이스는 비즈니스 메소드가 리턴한 결과 데이터를 다른 용도로 처리할 때 사용한다. 앞에서 작성한 AfterReturningAdvice 클래스에 관련된 어노테이션을 추가한다.

### 5.2.3 After Throwing 어드바이스

   After Throwing 어드바이스는 비즈니스 메소드 실행 도중에 예외가 발생했을 때, 공통적인 예외 처리 로직을 제공할 목적으로 사용하는 어드바이스이다.

   XML 설정에서는 throwing 속성을 사용하여 바인드 변수를 명확하게 지정할 수 있었다. 어노테이션 설정에서도 throwing 속성을 이용하여 바인드 변수를 지정할 수 있다.

### 5.2.4 After 어드바이스

   After 어드바이스는 예외 발생 여부에 상관없이 무조건 수행되는 어드바이스로서 @After 어노테이션을 사용하여 설정한다.

### 5.2.5 Around 어드바이스 설정

   어드바이스 메소드 중에서 유일하게 Around 메소드에서만 JoinPoint가 아닌 ProceedingJoinPoint 객체를 매개변수로 받는다. 그래야 proceed() 메소드를 이용하여 클라이언트가 호출한 비즈니스 메소드를 실행할 수 있기 때문이다.

### 5.2.6 외부 Pointcut 참조하기

   애스팩트를 설정할 때 Pointcut-ref 속성으로 특정 포인트컷을 참조할 수 있었기 때문에 포인트컷을 재사용할 수 있었다. 하지만 어노테이션 설정으로 변경하고부터는 어드바이스 클래스마다 포인트컷 설정이 포함되면서, 비슷하거나 같은 포인트컷이 반복 선언되는 문제가 발생한다. 스프링은 이런 문제를 해결하고자 포인트컷을 외부에 독립된 클래스에 따로 설정하도록 한다.